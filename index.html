<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembayaran Pro - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen py-8 px-4">
    <div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-3 w-80"></div>

    <div class="container mx-auto max-w-6xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-slate-800 mb-2 tracking-tight">Sistem Pembayaran Pro</h1>
            <p class="text-slate-500">Kelola transaksi dengan animasi, tabel, dan penyimpanan data.</p>
        </div>

        <div class="grid lg:grid-cols-5 gap-8">
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 transform hover:scale-[1.01] transition-transform duration-300">
                <form id="paymentForm" class="space-y-4">
                    <h2 class="text-xl font-bold text-slate-800 border-b pb-3 mb-4">Buat Transaksi Baru</h2>
                    
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Nama Pelanggan</label>
                        <input 
                            type="text" 
                            id="customerName" 
                            name="customerName" placeholder="Masukkan nama pelanggan" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" 
                            required>
                    </div>
                    <div>
                        <label for="customerEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input 
                            type="email" 
                            id="customerEmail" 
                            name="customerEmail" placeholder="contoh@email.com" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" 
                            required>
                    </div>
                    <div>
                        <label for="productSelect" class="block text-sm font-medium text-gray-700 mb-1">Pilih Produk/Layanan</label>
                        <select 
                            id="productSelect" 
                            name="product" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" 
                            required>
                            <option value="">Pilih produk...</option>
                            <option value="basic" data-price="50000">Paket Basic - Rp 50.000</option>
                            <option value="premium" data-price="100000">Paket Premium - Rp 100.000</option>
                            <option value="professional" data-price="200000">Paket Professional - Rp 200.000</option>
                            <option value="enterprise" data-price="500000">Paket Enterprise - Rp 500.000</option>
                        </select>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Jumlah</label>
                        <input 
                            type="number" 
                            id="quantity" 
                            name="quantity" min="1" 
                            value="1" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" 
                            required>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran</label>
                        <div class="grid grid-cols-2 gap-2">
                             <label class="flex items-center p-2 border rounded-lg hover:bg-slate-50 transition"><input type="radio" name="paymentMethod" value="transfer" class="text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Transfer Bank</span></label>
                             <label class="flex items-center p-2 border rounded-lg hover:bg-slate-50 transition"><input type="radio" name="paymentMethod" value="ewallet" class="text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">E-Wallet</span></label>
                             <label class="flex items-center p-2 border rounded-lg hover:bg-slate-50 transition"><input type="radio" name="paymentMethod" value="credit" class="text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Kartu Kredit</span></label>
                             <label class="flex items-center p-2 border rounded-lg hover:bg-slate-50 transition"><input type="radio" name="paymentMethod" value="cash" class="text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Bayar Tunai</span></label>
                        </div>
                    </div>
                    <div>
                        <label for="promoCode" class="block text-sm font-medium text-gray-700 mb-1">Kode Promo</label>
                        <div class="flex gap-2">
                            <input type="text" id="promoCode" placeholder="Masukkan kode promo" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                            <button type="button" id="resetPromoBtn" class="px-3 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 transition" title="Reset Promo">&#x21BA;</button>
                            <button type="button" id="applyPromoBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">Terapkan</button>
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 space-y-2">
                        <div class="flex justify-between items-center text-sm text-slate-600"><span>Subtotal:</span><span id="subtotal">Rp 0</span></div>
                        <div id="discountRow" class="flex justify-between items-center text-sm text-green-600 opacity-0 transition-opacity"><span>Diskon:</span><span id="discount">Rp 0</span></div>
                        <div class="flex justify-between items-center text-lg font-bold text-slate-800 border-t pt-2 mt-2"><span>Total:</span><span id="totalAmount">Rp 0</span></div>
                    </div>
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition transform hover:scale-105">Proses Pembayaran</button>
                </form>
            </div>

            <div class="lg:col-span-3 bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4 border-b pb-3">
                    <h2 class="text-xl font-bold text-slate-800">Riwayat Transaksi</h2>
                    <button id="clearHistoryBtn" class="px-4 py-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition opacity-0 hidden">Hapus Semua</button>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="text-center p-3 bg-blue-50 rounded-lg"><div class="text-2xl font-bold text-blue-600" id="totalTransactions">0</div><div class="text-sm text-gray-600">Transaksi</div></div>
                    <div class="text-center p-3 bg-green-50 rounded-lg"><div class="text-2xl font-bold text-green-600" id="totalRevenue">Rp 0</div><div class="text-sm text-gray-600">Pendapatan</div></div>
                    <div class="text-center p-3 bg-purple-50 rounded-lg"><div class="text-2xl font-bold text-purple-600" id="avgTransaction">Rp 0</div><div class="text-sm text-gray-600">Rata-rata</div></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3">Pelanggan</th>
                                <th scope="col" class="px-4 py-3">Detail Produk</th>
                                <th scope="col" class="px-4 py-3">Metode</th>
                                <th scope="col" class="px-4 py-3">Total</th>
                                <th scope="col" class="px-4 py-3">Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="transactionListBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 opacity-0 scale-95 pointer-events-none transition-all duration-300 ease-in-out">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform transition-all duration-300 ease-in-out">
             <div class="text-center mb-4">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Pembayaran Berhasil!</h3>
                <p class="text-gray-600">Transaksi Anda telah sukses diproses.</p>
            </div>
            <div id="paymentDetails" class="bg-gray-50 rounded-lg p-4 mb-4 text-sm space-y-2"></div>
            <button id="closeModalBtn" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Tutup</button>
        </div>
    </div>

    <template id="transactionTemplate">
        <tr class="bg-white border-b hover:bg-gray-50 transition">
            <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap transaction-customer"></td>
            <td class="px-4 py-3 transaction-product"></td>
            <td class="px-4 py-3 transaction-method"></td>
            <td class="px-4 py-3 font-semibold text-green-600 transaction-amount"></td>
            <td class="px-4 py-3 text-gray-500 transaction-time"></td>
        </tr>
    </template>
    
    <script>
        // Kode JavaScript tidak ada perubahan, karena masalahnya ada di HTML.
        // ===== DATA & VARIABEL GLOBAL =====
        let transactions = [];
        let currentDiscount = 0;
        let appliedPromoCode = '';
        
        const promoCodes = {
            "DISKON10": {type: "percentage", discount: 10, description: "Potongan 10%"},
            "HEMAT50K": {type: "fixed", discount: 50000, description: "Diskon tetap Rp 50.000"},
            "STUDENT20": {type: "percentage", discount: 20, description: "Diskon 20% pelajar"}
        };
        const paymentMethodColors = {'transfer': 'bg-blue-100 text-blue-800','ewallet': 'bg-purple-100 text-purple-800','credit': 'bg-orange-100 text-orange-800','cash': 'bg-green-100 text-green-800'};
        const paymentMethodNames = {'transfer': 'Transfer Bank','ewallet': 'E-Wallet','credit': 'Kartu Kredit','cash': 'Bayar Tunai'};

        // ===== SELEKSI ELEMEN DOM =====
        const paymentForm = document.getElementById('paymentForm');
        const productSelect = document.getElementById('productSelect');
        const quantity = document.getElementById('quantity');
        const promoCode = document.getElementById('promoCode');
        const applyPromoBtn = document.getElementById('applyPromoBtn');
        const resetPromoBtn = document.getElementById('resetPromoBtn');
        const subtotalEl = document.getElementById('subtotal');
        const discountEl = document.getElementById('discount');
        const discountRow = document.getElementById('discountRow');
        const totalAmountEl = document.getElementById('totalAmount');
        const transactionListBody = document.getElementById('transactionListBody');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const totalTransactionsEl = document.getElementById('totalTransactions');
        const totalRevenueEl = document.getElementById('totalRevenue');
        const avgTransactionEl = document.getElementById('avgTransaction');
        const paymentModal = document.getElementById('paymentModal');
        const paymentDetails = document.getElementById('paymentDetails');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const toastContainer = document.getElementById('toastContainer');
        const transactionTemplate = document.getElementById('transactionTemplate');

        // ===== FUNGSI UTILITY & UI =====
        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const getCurrentTime = () => new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            toast.className = `p-4 rounded-lg text-white shadow-lg transform translate-x-full opacity-0 transition-all duration-300 ease-in-out ${colors[type]}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 10);

            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }
        
        function showPaymentModal(transaction) {
            paymentDetails.innerHTML = `
                <div class="flex justify-between"><span>ID Transaksi:</span><span class="font-medium">${transaction.id}</span></div>
                <div class="flex justify-between"><span>Nama:</span><span class="font-medium">${transaction.customerName}</span></div>
                <div class="flex justify-between"><span>Produk:</span><span class="font-medium">${transaction.productName}</span></div>
                <div class="flex justify-between"><span>Metode:</span><span class="font-medium">${paymentMethodNames[transaction.paymentMethod]}</span></div>
                ${transaction.discount > 0 ? `<div class="flex justify-between text-green-600"><span>Diskon:</span><span class="font-medium">-${formatCurrency(transaction.discount)}</span></div>` : ''}
                <hr class="my-2"><div class="flex justify-between text-lg font-semibold"><span>Total:</span><span class="text-green-600">${formatCurrency(transaction.total)}</span></div>`;
            paymentModal.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        }

        const closeModal = () => paymentModal.classList.add('opacity-0', 'scale-95', 'pointer-events-none');

        // ===== FUNGSI KALKULASI & PROMO =====
        function updateTotal() {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const price = parseInt(selectedOption.dataset.price) || 0;
            const subtotal = price * (parseInt(quantity.value) || 1);
            
            const promoData = appliedPromoCode ? promoCodes[appliedPromoCode] : null;
            let discount = 0;
            if (promoData) {
                discount = promoData.type === 'percentage' ? Math.round(subtotal * promoData.discount / 100) : Math.min(promoData.discount, subtotal);
            }
            
            subtotalEl.textContent = formatCurrency(subtotal);
            discountEl.textContent = '-' + formatCurrency(discount);
            discountRow.classList.toggle('opacity-100', discount > 0);
            discountRow.classList.toggle('opacity-0', discount === 0);

            totalAmountEl.textContent = formatCurrency(subtotal - discount);
            currentDiscount = discount;
        }

        function applyPromo() {
            const code = promoCode.value.trim().toUpperCase();
            if (!code) return showToast('Masukkan kode promo', 'error');
            if (!promoCodes[code]) return showToast('Kode promo tidak valid', 'error');

            appliedPromoCode = code;
            updateTotal();
            showToast(`Promo "${promoCodes[code].description}" berhasil diterapkan!`, 'success');
            promoCode.disabled = true;
            applyPromoBtn.disabled = true;
            applyPromoBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        }
        
        function resetPromo() {
            appliedPromoCode = '';
            promoCode.value = '';
            promoCode.disabled = false;
            applyPromoBtn.disabled = false;
            applyPromoBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            updateTotal();
        }

        // ===== FUNGSI DATA (Local Storage & Rendering) =====
        const saveTransactions = () => localStorage.setItem('transactions', JSON.stringify(transactions));
        const loadTransactions = () => {
            const data = localStorage.getItem('transactions');
            transactions = data ? JSON.parse(data) : [];
        };
        
        function renderTransactions() {
            transactionListBody.innerHTML = ''; // Clear table body
            if (transactions.length === 0) {
                transactionListBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-8">Belum ada transaksi</td></tr>`;
                clearHistoryBtn.classList.add('opacity-0', 'hidden');
            } else {
                clearHistoryBtn.classList.remove('opacity-0', 'hidden');
                transactions.forEach(transaction => {
                    const row = transactionTemplate.content.cloneNode(true).querySelector('tr');
                    row.querySelector('.transaction-customer').textContent = transaction.customerName;
                    row.querySelector('.transaction-product').textContent = `${transaction.productName} (${transaction.quantity}x)`;
                    row.querySelector('.transaction-method').innerHTML = `<span class="px-2 py-1 text-xs rounded-full ${paymentMethodColors[transaction.paymentMethod]}">${paymentMethodNames[transaction.paymentMethod]}</span>`;
                    row.querySelector('.transaction-amount').textContent = formatCurrency(transaction.total);
                    row.querySelector('.transaction-time').textContent = transaction.time;
                    
                    row.classList.add('opacity-0', 'translate-y-2');
                    transactionListBody.prepend(row); // Prepend to show newest on top
                    setTimeout(() => row.classList.remove('opacity-0', 'translate-y-2'), 50);
                });
            }
            updateStatistics();
        }
        
        function updateStatistics() {
            const totalTrans = transactions.length;
            const totalRev = transactions.reduce((sum, t) => sum + t.total, 0);
            const avgTrans = totalTrans > 0 ? totalRev / totalTrans : 0;
            totalTransactionsEl.textContent = totalTrans;
            totalRevenueEl.textContent = formatCurrency(totalRev);
            avgTransactionEl.textContent = formatCurrency(avgTrans);
        }

        // ===== FUNGSI UTAMA (Event Handlers) =====
        function processPayment(e) {
            e.preventDefault();
            const formData = new FormData(paymentForm);
            if (!formData.get('paymentMethod')) return showToast('Pilih metode pembayaran!', 'error');

            const subtotal = (parseInt(productSelect.options[productSelect.selectedIndex].dataset.price) || 0) * (parseInt(formData.get('quantity')) || 1); // Fix: use formData here too for consistency
            const total = subtotal - currentDiscount;
            if (total < 0) return showToast('Total tidak boleh negatif!', 'error');

            const newTransaction = {
                id: 'TRX' + Date.now().toString().slice(-6),
                customerName: formData.get('customerName'),
                productName: productSelect.options[productSelect.selectedIndex].text.split(' - ')[0],
                quantity: parseInt(formData.get('quantity')),
                paymentMethod: formData.get('paymentMethod'),
                discount: currentDiscount,
                total: total,
                time: getCurrentTime()
            };

            transactions.push(newTransaction);
            saveTransactions();
            renderTransactions();
            showPaymentModal(newTransaction);
            paymentForm.reset();
            resetPromo();
        }
        
        function clearAllHistory() {
            if (confirm('Anda yakin ingin menghapus SEMUA riwayat transaksi? Aksi ini tidak dapat dibatalkan.')) {
                transactions = [];
                localStorage.removeItem('transactions');
                renderTransactions();
                showToast('Riwayat transaksi telah dihapus.', 'info');
            }
        }

        // ===== INISIALISASI & EVENT LISTENERS =====
        function initApp() {
            paymentForm.addEventListener('submit', processPayment);
            productSelect.addEventListener('change', updateTotal);
            quantity.addEventListener('input', updateTotal);
            applyPromoBtn.addEventListener('click', applyPromo);
            resetPromoBtn.addEventListener('click', resetPromo);
            clearHistoryBtn.addEventListener('click', clearAllHistory);
            closeModalBtn.addEventListener('click', closeModal);
            paymentModal.addEventListener('click', (e) => e.target === paymentModal && closeModal());
            document.addEventListener('keydown', (e) => e.key === 'Escape' && closeModal());
            
            loadTransactions();
            renderTransactions();
            updateTotal();
            document.getElementById('customerName').focus();
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>